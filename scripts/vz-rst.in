#!/bin/bash
#  Copyright (C) 2013-2015 Parallels IP Holdings GmbH
#
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program; if not, write to the Free Software
#  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#
#
# Resume a container using CRIU (http://criu.org).
# Useful with recent upstream (i.e. non-OpenVZ) kernels.
# Requires criu to be installed.
#
# Parameters are passed in environment variables.
# Required parameters:
#   VE_ROOT       - container root directory
#   VE_DUMP_DIR   - directory for saving dump files
#   VE_PIDFILE - file to write CT init PID to
# Optional parameters:
#   VE_VETH_DEVS  - pair of veth names (CT=HW\n)
exec 1>&2

veth_args=""
for dev in $VE_VETH_DEVS; do
	veth_args="$veth_args --veth-pair $dev"
done

action_script=@SCRIPTDIR@/vz-rst-action

d=$(dirname $VE_PIDFILE)
[ ! -d "$d" ] && mkdir -p "$d"

rm -f $VE_PIDFILE

# Extract additional arguments from special file (needed for live migration)
extra_args_path="$VE_DUMP_DIR/restore-extra-args"
[ -f "$extra_args_path" ] && eval $(. ${extra_args_path} && echo \
	VE_WORK_DIR="${VE_WORK_DIR}" \
	VE_RESTORE_LOG_PATH="${VE_RESTORE_LOG_PATH}")

# Setup default work directory if not explicitly specified
[ -z "$VE_WORK_DIR" ] && VE_WORK_DIR="$VE_DUMP_DIR"

# Setup default log name if not explicitly specified
[ -z "$VE_RESTORE_LOG_PATH" ] && VE_RESTORE_LOG_PATH="restore.log"

criu restore -vvvv					\
		--file-locks				\
		--tcp-established			\
		--evasive-devices			\
		--manage-cgroups			\
		--link-remap				\
		--root $VE_ROOT				\
		--ext-mount-map auto			\
		--enable-external-sharing		\
		--enable-external-masters		\
		--restore-detached			\
		--action-script $action_script		\
		-D $VE_DUMP_DIR				\
		-W $VE_WORK_DIR				\
		-o $VE_RESTORE_LOG_PATH			\
		--pidfile $VE_PIDFILE			\
		--cgroup-root /$VEID			\
		$veth_args

if [ $? -eq 0 ]; then
	echo Ok
else
	echo The restore log was saved in $VE_DUMP_DIR/restore.log
	exit 1
fi
